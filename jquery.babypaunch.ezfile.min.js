"use strict";$.fn.ezfile=function(json){var defaults={text:"업로드할 파일을 선택하세요.",limit:undefined,style:{icon:"style='display: none; background: gray; color: white; padding: 3px; margin-right: 5px;'",file:"style='float: right; border: 0; background: gray; color: white; padding: 0 2px;'",delete:"style='display: none; float: right; border: 0; background: gray; color: white; padding: 0 2px;'"},icon:{ppt:"maroon",pptx:"maroon",xls:"limegreen",xlsx:"limegreen",doc:"dodgerblue",docx:"dodgerblue","7z":"black",zip:"black",jar:"black",tar:"black",tgz:"black",alz:"black",tgz:"black",html:"skyblue",htm:"skyblue",png:"orange",gif:"orange",jpg:"orange",jpeg:"orange",bmp:"orange"}};var ezfile={file:function($element){var name=$element[0].files[0].name;return{name:name.substr(0,name.lastIndexOf(".")),ext:name.substr(name.lastIndexOf(".")+1)}},isExt:function($element,defaults){if(defaults.ext===undefined){return!0}
var result=!0;var name=this.file($element);switch($.type(defaults.ext)){case "string":if(defaults.ext.toLowerCase()!==name.ext){result=!1;alert("업로드 파일의 확장자는 대소문자 구분없이 "+defaults.ext+"만 허용됩니다.")}
break;case "array":result=!1;for(var i=0;i<defaults.ext.length;i++){if(defaults.ext[i].toLowerCase()===name.ext){result=!0;break}}
if(!result){alert("업로드 파일의 확장자는 대소문자 구분없이 "+defaults.ext.join()+"만 허용됩니다.")}
break;default:result=!1;alert("파일의 확장자는 문자열이나 배열만 입력할 수 있습니다.");break}
return result},uploadable:function($element,defaults,callback){var result=!0;var fr=new FileReader();fr.readAsDataURL($element[0].files[0]);fr.onload=function(){if(defaults.byte!==undefined){var flag=defaults.byte.toLowerCase();var bytes=Number(defaults.byte.replace(/[^0-9]/g,""));for(var i=0,arr=["k","m","g","t","p"];i<arr.length;i++){if(flag.lastIndexOf(arr[i])!==-1){result=$element[0].files[0].size<bytes*Math.pow(1024,i+1)?!0:!1}}
if(!result){alert("업로드 파일의 용량은 "+defaults.byte+"이하로 제한합니다.");callback(result);return}}
if(defaults.size!==undefined||defaults.ratio!==undefined){var img=new Image();img.src=fr.result;img.onload=function(){if(defaults.size!==undefined){var size={width:Number(defaults.size[0]),height:Number(defaults.size[1]),smaller:defaults.size[2]||!1};if(size.smaller){result=this.width<=size.width&&this.height<=size.height?!0:!1;if(!result){alert("이미지 파일의 크기는 가로("+size.width+"px), 세로("+size.height+"px)보다 작거나 같아야 합니다.")}}else{result=this.width===size.width&&this.height===size.height?!0:!1;if(!result){alert("이미지 파일의 크기는 가로("+size.width+"px), 세로("+size.height+"px)와 같아야 합니다.")}}}
if(defaults.ratio!==undefined){var ratio={x:Number(defaults.ratio[0]),y:Number(defaults.ratio[1])};var compares=[Math.round(this.width/100),Math.round(this.height/100)];result=compares[0]===ratio.x&&compares[1]===ratio.y?!0:!1;if(!result){alert("이미지 파일의 비율은 가로("+ratio.x+"), 세로("+ratio.y+")이여야 합니다.")}}
this.remove();callback(result)};img.onerror=function(){alert("정상적인 이미지 파일이 아닙니다.");this.remove();callback(!1)}}}}};$.extend(!0,defaults,json);return this.each(function(){var $root=$(this);var html=""+"<div style='border: 1px solid silver; padding: 3px; margin: 5px; width: 100%;'>"+"<span class='icon'"+defaults.style.icon+"></span>"+"<span class='text'>"+defaults.text+"</span>"+"<input type='file' name='"+defaults.name+"' style='display: none;'/>"+"<button class='file' type='button' "+defaults.style.file+">FILE</button>"+"<button class='delete' type='button' "+defaults.style.delete+">Delete</button>"+"</div>";$root.html(html).on("click","button.file",function(){$(this).prev("input").trigger("click")}).on("change","input[type='file']",function(){var $parent=$(this).parent();var $wrapper=$parent.parent();var file=ezfile.file($(this));if(!ezfile.isExt($(this),defaults)){$parent.remove();$root.append(html);return}
if(defaults.limit!==undefined){if(defaults.limit===0){$root.append(html)}else{if(defaults.limit>$root.find("input[type='file'][name='"+$(this).attr("name")+"']").length){$root.append(html)}}}
$(this).prev("span.text").text(file.name).prev("span.icon").show().css({"background":defaults.icon[file.ext]||"gray"}).text(file.ext).end().end().next("button.file").hide().next("button.delete").show();ezfile.uploadable($(this),defaults,function(result){if(!result){$parent.remove();if(defaults.limit===undefined){$root.append(html)}else{if(defaults.limit!==0){var appendable=0;$wrapper.find("input[type=file]").each(function(){if($(this).val().length>0){appendable++}});if(defaults.limit-1===appendable){$root.append(html)}}}}})}).on("click","button.delete",function(){$(this).parent().remove();if(defaults.limit===undefined){$root.append(html)}else{var $files=$root.find("input[type='file'][name='"+$(this).prev().prev().attr("name")+"']");var count=0;$files.each(function(){if($(this).val()!==""){count++}});if($files.length===count){$root.append(html)}}})})}
